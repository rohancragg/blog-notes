<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Keeping Virtual Machines Patched (the Azure DevTest Labs edition)"><meta name=author content="Rohan Cragg"><link href=https://rohancragg.co.uk/devops/azdo-self-hosted-build-agents/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.2.9"><title>Azure DevOps - Self-Hosted Build Agents - What I learned today (@rohancragg)</title><link rel=stylesheet href=../../assets/stylesheets/main.120efc48.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.9647289d.min.css><meta name=theme-color content=#7e56c2><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"Ubuntu Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:title content="Azure DevOps - Self-Hosted Build Agents"><meta property=og:type content=website><meta content=https://rohancragg.co.uk/devops/azdo-self-hosted-build-agents/ property=og:url><meta property=og:image:url content=https://rohancragg.co.uk/devops/media/agent-config-sh.png><meta property=og:image:type content=image/png><meta property=og:description content="Keeping Virtual Machines Patched (the Azure DevTest Labs edition)"><meta property=og:locale content=en-GB><meta property=fb:app_id content=245640346829400></head> <body dir=ltr data-md-color-scheme data-md-color-primary=deep-purple data-md-color-accent=green> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#self-hosted-agents class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="What I learned today (@rohancragg)" class="md-header__button md-logo" aria-label="What I learned today (@rohancragg)" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> What I learned today (@rohancragg) </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Azure DevOps - Self-Hosted Build Agents </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/rohancragg/blog-notes title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> rohancragg/blog-notes </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="What I learned today (@rohancragg)" class="md-nav__button md-logo" aria-label="What I learned today (@rohancragg)" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> What I learned today (@rohancragg) </label> <div class=md-nav__source> <a href=https://github.com/rohancragg/blog-notes title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> rohancragg/blog-notes </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../about/ class=md-nav__link> About Me </a> </li> <li class=md-nav__item> <a href=../../whats-new/ class=md-nav__link> What's New </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Tools & Techniques <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Tools & Techniques" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Tools & Techniques </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../misc/cloud-dev-vms/ class=md-nav__link> A Dev VM in the sky </a> </li> <li class=md-nav__item> <a href=../../misc/shapes/ class=md-nav__link> Import Shapes into Draw.io </a> </li> <li class=md-nav__item> <a href=../../misc/scoop/ class=md-nav__link> Scoop & Co </a> </li> <li class=md-nav__item> <a href=../../misc/git-bash/ class=md-nav__link> Bash Shell on Windows </a> </li> <li class=md-nav__item> <a href=../../misc/ps-module-paths/ class=md-nav__link> About PowerShell Module Paths </a> </li> <li class=md-nav__item> <a href=../../misc/misc/ class=md-nav__link> Miscellanous Notes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> DevOps <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=DevOps data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> DevOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../devops-for-the-terrified/ class=md-nav__link> DevOps for the Terrified </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Azure DevOps - Self-Hosted Build Agents <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Azure DevOps - Self-Hosted Build Agents </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#self-hosted-agents class=md-nav__link> Self-Hosted Agents </a> </li> <li class=md-nav__item> <a href=#configuring-an-agent-on-ubuntu-server class=md-nav__link> Configuring an agent on Ubuntu Server </a> <nav class=md-nav aria-label="Configuring an agent on Ubuntu Server"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-0-pre-requisites class=md-nav__link> Step 0. Pre-requisites </a> </li> <li class=md-nav__item> <a href=#step-1-create-an-account-under-which-to-run-the-agent class=md-nav__link> Step 1. Create an account under which to run the Agent </a> </li> <li class=md-nav__item> <a href=#step-2-install-git2 class=md-nav__link> Step 2. Install Git2 </a> </li> <li class=md-nav__item> <a href=#step-3-install-and-configure-the-agent class=md-nav__link> Step 3. Install and configure the Agent </a> </li> <li class=md-nav__item> <a href=#step-4-run-as-a-service class=md-nav__link> Step 4. Run as a Service </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#installing-capabilities class=md-nav__link> Installing Capabilities </a> <nav class=md-nav aria-label="Installing Capabilities"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#python-tools class=md-nav__link> Python Tools </a> <nav class=md-nav aria-label="Python Tools"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-create-tool-cache-directory class=md-nav__link> 1. Create Tool Cache Directory </a> </li> <li class=md-nav__item> <a href=#2-install-python class=md-nav__link> 2. Install Python </a> </li> <li class=md-nav__item> <a href=#3-install-conda class=md-nav__link> 3. Install Conda </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../compute/patching-devtestlabs/ class=md-nav__link> VM Patching in DevTest Labs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aks/domains/ class=md-nav__link> Clusters and Domains </a> </li> <li class=md-nav__item> <a href=../../aks/create-tls-secret/ class=md-nav__link> Create a TLS Secret </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Writing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Writing data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Writing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../writing/social-media-sharing/ class=md-nav__link> Prettier link sharing with MkDocs </a> </li> <li class=md-nav__item> <a href=../../writing/diagrams/ class=md-nav__link> Technical Diagramming </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#self-hosted-agents class=md-nav__link> Self-Hosted Agents </a> </li> <li class=md-nav__item> <a href=#configuring-an-agent-on-ubuntu-server class=md-nav__link> Configuring an agent on Ubuntu Server </a> <nav class=md-nav aria-label="Configuring an agent on Ubuntu Server"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-0-pre-requisites class=md-nav__link> Step 0. Pre-requisites </a> </li> <li class=md-nav__item> <a href=#step-1-create-an-account-under-which-to-run-the-agent class=md-nav__link> Step 1. Create an account under which to run the Agent </a> </li> <li class=md-nav__item> <a href=#step-2-install-git2 class=md-nav__link> Step 2. Install Git2 </a> </li> <li class=md-nav__item> <a href=#step-3-install-and-configure-the-agent class=md-nav__link> Step 3. Install and configure the Agent </a> </li> <li class=md-nav__item> <a href=#step-4-run-as-a-service class=md-nav__link> Step 4. Run as a Service </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#installing-capabilities class=md-nav__link> Installing Capabilities </a> <nav class=md-nav aria-label="Installing Capabilities"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#python-tools class=md-nav__link> Python Tools </a> <nav class=md-nav aria-label="Python Tools"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-create-tool-cache-directory class=md-nav__link> 1. Create Tool Cache Directory </a> </li> <li class=md-nav__item> <a href=#2-install-python class=md-nav__link> 2. Install Python </a> </li> <li class=md-nav__item> <a href=#3-install-conda class=md-nav__link> 3. Install Conda </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/rohancragg/blog-notes/edit/master/docs/devops/azdo-self-hosted-build-agents.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>Azure DevOps - Self-Hosted Build Agents</h1> <h2 id=self-hosted-agents>Self-Hosted Agents<a class=headerlink href=#self-hosted-agents title="Permanent link">&para;</a></h2> <details class=info> <summary>About Build Agents</summary> <p>This new Learning Module has some very good explanations:</p> <blockquote> <p>A build agent is a system that performs build tasks. Think of it as a dedicated server that runs your build process.</p> <p>Imagine that you have an Azure Pipelines project that receives build requests many times per day. Or perhaps you have multiple projects that can each use the same type of build agent. You can organize build agents into agent pools to help ensure that there's a server ready to process each build request.</p> <p>When a build is triggered, Azure Pipelines selects an available build agent from the pool. If all agents are busy, the process waits for one to become available.</p> </blockquote> <p>from <a href=https://docs.microsoft.com/en-us/learn/modules/host-build-agent/ >docs.microsoft.com/en-us/learn/modules/host-build-agent/</a></p> </details> <p>When my colleagues needed a build agent that could communicate with Azure Resources (such as Storage Accounts) inside of a private Virtual Network then the only way to do this without whitelisting a very large set of public IP address ranges (i.e. Azure Datacenter addresses) was to have a Virtual Machine running inside the same private network to which Azure DevOps would schedule build jobs.</p> <p>Azure DevOps provides a way for you to run your own Build Agents called <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/agents?view=azure-devops"><strong>Self-hosted Agents</strong></a>.</p> <h2 id=configuring-an-agent-on-ubuntu-server>Configuring an agent on Ubuntu Server<a class=headerlink href=#configuring-an-agent-on-ubuntu-server title="Permanent link">&para;</a></h2> <p>When I learned that the requirement was to build Python wheels to be deployed. I guessed that a Linux Virtual Machine should suffice and be a bit less costly to run that a Windows Server Virtual Machine. I elected to deploy a Ubuntu Server.</p> <p>When I looked into this I found a few blog posts in addition to <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops">the official documentation</a>, but all the articles specified using a desktop browser to download the Agent configuration script, and this seemed very odd for Linux where I'd assumed the default mode would be to do everything at the command line so I thought I'd post here how I acheived all of this with just an SSH terminal.</p> <h3 id=step-0-pre-requisites>Step 0. Pre-requisites<a class=headerlink href=#step-0-pre-requisites title="Permanent link">&para;</a></h3> <p>Update the <code>apt</code> package manager cache</p> <div class=highlight><pre><span></span><code>sudo apt-get update
</code></pre></div> <h3 id=step-1-create-an-account-under-which-to-run-the-agent>Step 1. Create an account under which to run the Agent<a class=headerlink href=#step-1-create-an-account-under-which-to-run-the-agent title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>sudo adduser agentsvc
sudo usermod -aG sudo agentsvc
<span class=c1># test it</span>
su - agentsvc
sudo ls -la /root
</code></pre></div> <h3 id=step-2-install-git2>Step 2. Install Git2<a class=headerlink href=#step-2-install-git2 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>sudo add-apt-repository ppa:git-core/ppa
sudo apt-get update
sudo apt-get install git
</code></pre></div> <h3 id=step-3-install-and-configure-the-agent>Step 3. Install and configure the Agent<a class=headerlink href=#step-3-install-and-configure-the-agent title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>mkdir -p <span class=nv>$HOME</span>/Downloads <span class=o>&amp;&amp;</span> <span class=nb>cd</span> <span class=nv>$HOME</span>/Downloads
curl -o <span class=nv>$HOME</span>/Downloads/vsts-agent-linux-x64-2.165.0.tar.gz https://vstsagentpackage.azureedge.net/agent/2.165.0/vsts-agent-linux-x64-2.165.0.tar.gz
<span class=nb>cd</span> <span class=nv>$HOME</span>
mkdir -p <span class=nv>$HOME</span>/myagent/ <span class=o>&amp;&amp;</span> <span class=nb>cd</span> <span class=nv>$HOME</span>/myagent/
tar zxvf <span class=nv>$HOME</span>/Downloads/vsts-agent-linux-x64-2.165.0.tar.gz
rm -rf <span class=nv>$HOME</span>/Downloads
<span class=nb>cd</span> <span class=nv>$HOME</span>/myagent
sudo ./bin/installdependencies.sh
./config.sh
</code></pre></div> <p>You'll see something like this and you are prompted to enter the Azure Devops Organsation ULR and a PAT token:</p> <p><img alt=Image src=../media/agent-config-sh.png></p> <details class="tip all-in-one script"> <summary>Tip</summary> <p>There's an even more slick way to do the above steps here: <a href=https://github.com/MicrosoftDocs/mslearn-azure-pipelines-build-agent/blob/master/build-agent.sh>github.com/MicrosoftDocs/mslearn-azure-pipelines-build-agent/blob/master/build-agent.sh</a></p> </details> <h3 id=step-4-run-as-a-service>Step 4. Run as a Service<a class=headerlink href=#step-4-run-as-a-service title="Permanent link">&para;</a></h3> <p>Now we usually want to run the agent as a service (i.e. have it run continuously waiting for job to be scheduled) so we need to do the following, <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops#run-as-a-systemd-service">as documented here</a>.</p> <div class=highlight><pre><span></span><code>sudo <span class=nv>$HOME</span>/myagent/svc.sh install
sudo <span class=nv>$HOME</span>/myagent/svc.sh start
</code></pre></div> <hr> <h2 id=installing-capabilities>Installing Capabilities<a class=headerlink href=#installing-capabilities title="Permanent link">&para;</a></h2> <h3 id=python-tools>Python Tools<a class=headerlink href=#python-tools title="Permanent link">&para;</a></h3> <p>The following is the sterling work of my colleague <a class="magiclink magiclink-twitter magiclink-mention" href=https://twitter.com/chyuibacca title="Twitter User: chyuibacca">@chyuibacca</a>.</p> <p>The aim was to install the required Python tools onto the agent so that we could run a Pipeline that includes the following Tasks:</p> <ul> <li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/tool/use-python-version?view=azure-devops">UsePythonVersion@0</a></li> <li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/package/pip-authenticate?view=azure-devops">PipAuthenticate@1</a></li> </ul> <p>As well as a number of script tasks that use the <a href="https://docs.microsoft.com/en-us/python/api/overview/azure/ml/install?view=azure-ml-py">Azure Machine Learning SDK for Python</a> - also known as <code>azureml-sdk</code> (which gets installed via PyPI from <a href=https://pypi.org/project/azureml-defaults/ >pypi.org/project/azureml-defaults/</a>)</p> <h4 id=1-create-tool-cache-directory>1. Create Tool Cache Directory<a class=headerlink href=#1-create-tool-cache-directory title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code>mkdir -p <span class=nv>$HOME</span>/myagent/_work/_tool
</code></pre></div> <h4 id=2-install-python>2. Install Python<a class=headerlink href=#2-install-python title="Permanent link">&para;</a></h4> <p>Install tools required to build Python from source: <div class=highlight><pre><span></span><code>sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev  libncursesw5-dev xz-utils tk-dev
</code></pre></div></p> <p>Install required Python version (replace <code>x.y.z</code> with the required Python version, e.g. 3.6.7): <div class=highlight><pre><span></span><code>wget https://www.python.org/ftp/python/3.6.7/Python-x.y.z.tgz
tar -xzf Python-x.y.z.tgz
<span class=nb>cd</span> Python-x.y.z

mkdir -p <span class=nv>$HOME</span>/myagent/_work/_tool/Python/x.y.z/x64
./configure --prefix<span class=o>=</span><span class=nv>$HOME</span>/myagent/_work/_tool/Python/x.y.z/x64/ --enable-optimizations --with-ensurepip<span class=o>=</span>install
make -j <span class=m>8</span>
sudo make altinstall
touch <span class=nv>$HOME</span>/myagent/_work/_tool/Python/x.y.z/x64.complete
</code></pre></div></p> <p>If required, create major/ major.minor version link to latest Python version: <div class=highlight><pre><span></span><code>ln -s <span class=nv>$HOME</span>/myagent/_work/_tool/Python/x/x64 <span class=nv>$HOME</span>/myagent/_work/_tool/Python/x.y.z/x64
ln -s <span class=nv>$HOME</span>/myagent/_work/_tool/Python/x.y/x64 <span class=nv>$HOME</span>/myagent/_work/_tool/Python/x.y.z/x64
</code></pre></div></p> <h4 id=3-install-conda>3. Install Conda<a class=headerlink href=#3-install-conda title="Permanent link">&para;</a></h4> <p>Install the latest Conda release: <div class=highlight><pre><span></span><code>mkdir -p <span class=nv>$HOME</span>/myagent/_work/_tool/miniconda
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash ./Miniconda3-latest-Linux-x86_64.sh
</code></pre></div> Note: When prompted, select the installation directory as <code>/home/agentsvc/myagent/_work/_tool/minconda</code></p> <p>Initialise Conda: <div class=highlight><pre><span></span><code><span class=nb>eval</span> <span class=s2>&quot;</span><span class=k>$(</span>/home/agentsvc/myagent/_work/_tool/miniconda3/bin/conda shell.bash hook<span class=k>)</span><span class=s2>&quot;</span>
conda init bash
conda config --set auto_activate_base <span class=nb>false</span>
</code></pre></div></p> <p>Make Conda available to the agent by adding <code>/home/agentsvc/myagent/_work/_tool/miniconda3/condabin</code> to the PATH agent environment variable: <div class=highlight><pre><span></span><code>vi $HOME/myagent/.path
</code></pre></div></p> <hr> <div class=md-source-file> <small> Last update: 2020-04-01 </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../devops-for-the-terrified/ class="md-footer__link md-footer__link--prev" aria-label="Previous: DevOps for the Terrified" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> DevOps for the Terrified </div> </div> </a> <a href=../../compute/patching-devtestlabs/ class="md-footer__link md-footer__link--next" aria-label="Next: VM Patching in DevTest Labs" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> VM Patching in DevTest Labs </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2019 - 2020 Rohan Cragg </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://www.linkedin.com/in/rohancragg target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://twitter.com/rohancragg target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://github.com/rohancragg target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://fb.com/rohancragg target=_blank rel=noopener title=fb.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg> </a> <a href=https://www.instagram.com/rohancragg/ target=_blank rel=noopener title=www.instagram.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> <a href=https://asciinema.org/~rohancragg target=_blank rel=noopener title=asciinema.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M9.372 86.63c-12.496-12.5-12.496-32.76 0-45.26 12.498-12.49 32.758-12.49 45.258 0L246.6 233.4c12.5 12.5 12.5 32.7 0 45.2l-191.97 192c-12.5 12.5-32.76 12.5-45.258 0-12.496-12.5-12.496-32.7 0-45.2L178.7 256 9.372 86.63zM544 416c17.7 0 32 14.3 32 32s-14.3 32-32 32H256c-17.7 0-32-14.3-32-32s14.3-32 32-32h288z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["tabs", "instant"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.6e54b5cd.min.js></script> <script src=../../js/extra.js></script> <script src=https://platform.linkedin.com/badges/js/profile.js></script> </body> </html>